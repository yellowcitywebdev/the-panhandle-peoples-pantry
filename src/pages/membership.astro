---
import Container from "../components/Container.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import HeroInner from "../components/PageBanner.astro";

const title = "Membership";
const desc = "";
const image = "/hero-inner.webp";

//const web3FormsAccessKey = import.meta.env.WEB3FORMS_ACCESS_KEY; //dev
const web3FormsAccessKey = process.env.WEB3FORMS_ACCESS_KEY; //prod
---

<BaseLayout
  title="Membership Form"
  description="Want to join P³? Fill out this form and we will reach out to you!"
>
  <HeroInner title={title} desc={desc} image={image} />
  <Container class="text-gray-600 dark:text-gray-300">
    <section class="mt-16 bg-white dark:bg-gray-800 lg:mt-0">
      <div class="mx-auto max-w-screen-md px-4 py-8 lg:pb-4 lg:pt-16">
        <div class="text prose">
          <h2
            class="my-4 text-3xl font-bold text-gray-600 dark:text-white sm:text-4xl"
          >
            <span class="text-primary-500">Membership</span> form
          </h2>
          <div class="text-justify text-gray-700 dark:text-gray-200">
            <p>
              Want to join the co-op? Fill out this form and we will reach out
              to you!
            </p>
          </div>
        </div>
        <form
          action="https://api.web3forms.com/submit"
          method="POST"
          id="form"
          data-astro-reload
          class="space-y-4"
        >
          <!-- Add your Web3Forms Access Key -->
          <!-- env goes in root -->
          <input type="hidden" name="access_key" value={web3FormsAccessKey} />
          <!-- value="YOUR_ACCESS_KEY_HERE" -->

          <input
            type="hidden"
            name="subject"
            id="subject"
            value="New P³ Membership Form Submission"
          />
          <input type="hidden" name="form_name" value="Membership Form" />

          <input
            type="checkbox"
            class="hidden"
            style="display:none"
            name="botcheck"
          />
          <div class="flex flex-col gap-4 sm:flex-row">
            <div class="w-full sm:w-1/2">
              <label
                for="first_name"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >First Name</label
              >
              <input
                type="text"
                name="first_name"
                id="first_name"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="John"
                required
              />
            </div>
            <div class="w-full sm:w-1/2">
              <label
                for="last_name"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >Last Name</label
              >
              <input
                type="text"
                name="last_name"
                id="last_name"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="Brown"
                required
              />
            </div>
          </div>

          <div class="flex flex-col gap-4 sm:flex-row">
            <div class="w-full sm:w-1/2">
              <label
                for="email"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >Email</label
              >
              <input
                type="email"
                name="email"
                id="email"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="john.brown@gmail.com"
                required
              />
            </div>
            <div class="w-full sm:w-1/2">
              <label
                for="phone_number"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >Phone Number</label
              >
              <input
                type="tel"
                name="phone_number"
                id="phone_number"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="555-555-5555"
                maxlength="12"
                required
                pattern="([0-9]{3}-[0-9]{3}-[0-9]{4}|[0-9]{10})"
                title="Phone number must be in the format 555-555-5555 or 4445556666"
              />
            </div>
          </div>

          <div>
            <label
              for="address"
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
              >Address</label
            >
            <input
              type="text"
              name="address"
              id="address"
              class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="house or apt number, city, state, zip"
              required
            />
          </div>

          <div class="flex flex-col gap-4 sm:flex-row">
            <div class="w-full sm:w-1/2">
              <label
                for="birth_date"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >Date of Birth</label
              >
              <input
                type="text"
                name="birth_date"
                id="birth_date"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="MM/DD/YYYY"
                title="Date of Birth must be in MM/DD/YYYY format and cannot be in the future"
                maxlength="10"
              />
            </div>

            <div class="w-full sm:w-1/2">
              <label
                for="pronouns"
                class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
                >Preferred Pronouns</label
              >
              <input
                type="text"
                name="pronouns"
                id="pronouns"
                class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                placeholder="he/him, she/her, they/them, etc."
                required
              />
            </div>
          </div>
          <div>
            <label
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
            >
              Are you interested in becoming a member of our community?
            </label>

            <div class="flex flex-col gap-4 sm:flex-row">
              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="membership"
                  value="yes"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">Yes</span>
              </label>

              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="membership"
                  value="no"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">No</span>
              </label>
            </div>
          </div>

          <!-- "How did you hear about us?" Section -->
          <div>
            <label
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
            >
              How did you hear about us?
            </label>

            <div class="flex flex-col gap-4 sm:flex-row">
              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="referral"
                  value="social_media"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">Social Media</span>
              </label>

              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="referral"
                  value="friend"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">Friend/Family</span>
              </label>
              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="referral"
                  value="community_event"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white"
                  >Community Event</span
                >
              </label>

              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="referral"
                  value="other"
                  required
                  id="referral_other_option"
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">Other</span>
              </label>
            </div>

            <input
              type="text"
              name="referral_other_response"
              id="referral_other_response"
              class="mt-3 hidden w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Please specify"
            />
          </div>

          <!-- "Are you interested in participating in or supporting an equipment library?" Section -->
          <div>
            <label
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
            >
              Are you interested in other community projects (e.g., community
              gardens, mutual aid networks)?
            </label>

            <div class="flex flex-col gap-4 sm:flex-row">
              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="Interest_other_projects"
                  value="yes"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">Yes</span>
              </label>

              <label class="flex items-center space-x-2">
                <input
                  type="radio"
                  name="Interest_other_projects"
                  value="no"
                  required
                  class="h-5 w-5 text-primary-500"
                />
                <span class="text-gray-900 dark:text-white">No</span>
              </label>
            </div>
          </div>

          <!-- "Do you have any skills?" Section -->
          <div class="sm:col-span-2">
            <label
              for="contributions"
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
              >Do you have any skills, resources, or ideas you'd like to
              contribute to the community?</label
            >
            <textarea
              id="contributions"
              name="contributions"
              rows="3"
              minlength="0"
              class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Food safety and handling, outreach and education, public speaking..."
            ></textarea>
          </div>

          <div class="sm:col-span-2">
            <label
              for="contributions"
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
              >Do you have any accessibility needs or accommodations we should
              be aware of?</label
            >
            <textarea
              id="contributions"
              name="contributions"
              rows="3"
              minlength="0"
              class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Wheelchair access, sign language interpretation, sensory issues..."
            ></textarea>
          </div>

          <!-- "Do you have any dietary restrictions?" Section -->
          <div class="sm:col-span-2">
            <label
              for="Dietary_restrictions"
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
              >Do you have any dietary restrictions?</label
            >
            <textarea
              id="Dietary_restrictions"
              "
              name="Dietary_restrictions"
              "
              rows="3"
              minlength="0"
              class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Nut allergy, lactose intolerance, vegetarian, vegan..."
            ></textarea>
          </div>

          <!-- Additional comments section -->
          <div class="sm:col-span-2">
            <label
              for="Comments_questions"
              class="mb-2 block text-lg font-medium text-gray-600 dark:text-gray-300"
              >Additional comments or questions?</label
            >
            <textarea
              id="Comments_questions"
              name="Comments_questions"
              rows="3"
              minlength="0"
              class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 placeholder-gray-400 hover:ring-1 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white dark:placeholder-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
              placeholder="Leave a comment..."></textarea>
          </div>

          <button
            type="submit"
            class="mt-4 bg-primary-500 px-4 py-2 text-center font-bold text-white hover:bg-primary-600 dark:bg-primary-600 dark:hover:bg-primary-700"
            >Submit</button
          >
          <div id="result" class="mt-3 text-center"></div>
        </form>
      </div>
    </section>
  </Container>
</BaseLayout>

<script is:inline>
  document.addEventListener(
    "DOMContentLoaded",
    () => {
      const form = document.getElementById("form");
      const result = document.getElementById("result");

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        form.classList.add("was-validated");

        if (!form.checkValidity()) {
          form.querySelectorAll(":invalid")[0].focus();
          return;
        }

        const formData = new FormData(form);
        const object = Object.fromEntries(formData);
        const json = JSON.stringify(object);

        result.innerHTML = "Sending...";

        fetch("https://api.web3forms.com/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: json,
        })
          .then(async (response) => {
            let json = await response.json();
            if (response.status == 200) {
              result.classList.add("text-green-500");
              result.innerHTML = json.message;
              // Redirect to home page after a successful submission
              setTimeout(() => {
                window.location.href = "/";
              }, 2000); // 2 seconds delay before redirection
            } else {
              console.log(response);
              result.classList.add("text-red-500");
              result.innerHTML = json.message;
            }
          })
          .catch((error) => {
            console.log(error);
            result.innerHTML = "Something went wrong!";
          })
          .then(function () {
            form.reset();
            form.classList.remove("was-validated");
            setTimeout(() => {
              result.style.display = "none";
            }, 5000);
          });
      });
    },
    { once: true },
  );
</script>

<script is:inline>
  document
    .getElementById("birth_date")
    .addEventListener("input", function (event) {
      let input = event.target;
      let value = input.value.replace(/[^0-9/]/g, ""); // Allow only numbers and "/"

      // Auto-format as MM/DD/YYYY
      if (value.length > 2 && value.charAt(2) !== "/") {
        value = value.slice(0, 2) + "/" + value.slice(2);
      }
      if (value.length > 5 && value.charAt(5) !== "/") {
        value = value.slice(0, 5) + "/" + value.slice(5);
      }

      // Limit to 10 characters
      input.value = value.slice(0, 10);
    });

  document.getElementById("birth_date").addEventListener("blur", function () {
    let input = this;

    let regex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/(19|20)\d{2}$/;
    let isValidFormat = regex.test(input.value);

    // Ensure the year is not in the future
    let parts = input.value.split("/");
    let year = parseInt(parts[2], 10);
    let currentYear = new Date().getFullYear();

    if (!isValidFormat || year > currentYear) {
      input.setCustomValidity(
        "Date of Birth must be in MM/DD/YYYY format and cannot be in the future",
      );
    } else {
      input.setCustomValidity("");
    }
  });
</script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    function handleOtherField(radioName, otherOptionId, otherResponseId) {
      const otherOption = document.getElementById(otherOptionId);
      const otherResponse = document.getElementById(otherResponseId);
      const radioButtons = document.querySelectorAll(
        `input[name="${radioName}"]`,
      );

      radioButtons.forEach((radio) => {
        radio.addEventListener("change", function () {
          if (otherOption.checked) {
            otherResponse.classList.remove("hidden");
            otherResponse.setAttribute("required", "true");
          } else {
            otherResponse.classList.add("hidden");
            otherResponse.removeAttribute("required");
            otherResponse.value = ""; // Clear the field when hidden
          }
        });
      });
    }

    handleOtherField(
      "referral",
      "referral_other_option",
      "referral_other_response",
    );

    // template for future use
    // copy how referral is done
    handleOtherField("name", "name-other-option", "name-other-response");
  });
</script>
